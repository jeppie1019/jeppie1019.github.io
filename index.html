<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ç¨ - çµ‚æ¥µä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --container-bg: #ffffff;
            --grid-size: 630px; 
            --cell-size: 70px;  
            --thick-border: 5px solid #000;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            transition: background-color 1s ease, transform 0.1s;
        }

        /* ç­”å°æ™‚èƒŒæ™¯è®Šç¶  */
        body.victory-bg {
            background-color: #27ae60 !important;
        }

        /* ç­”éŒ¯æµè¡€éœ‡å‹• */
        .shake-screen { animation: screen-shake 0.1s ease-in-out infinite; }
        @keyframes screen-shake {
            0% { transform: translate(3px, 3px); }
            50% { transform: translate(-3px, -3px); }
            100% { transform: translate(3px, 3px); }
        }

        .container {
            text-align: center;
            background: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
            transition: transform 2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .rotate-win { transform: rotate(1080deg) scale(1.1); }

        h1 { 
            color: #1a1a1a; 
            font-size: 5.5rem; 
            margin: 0 0 20px 0; 
            letter-spacing: 25px;
            font-weight: 900;
        }

        /* æ•¸ç¨å¤§ç›¤é¢ - ä¹å®®æ ¼é‚Šæ¡†åŠ æ·± */
        .grid {
            display: grid;
            grid-template-columns: repeat(9, var(--cell-size));
            grid-template-rows: repeat(9, var(--cell-size));
            width: var(--grid-size);
            height: var(--grid-size);
            border: var(--thick-border); /* æœ€å¤–å±¤åŠ æ·± */
            margin: 0 auto;
            background-color: #ccc; /* æ™®é€šé‚Šç·šé¡è‰² */
            gap: 1px;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px; 
            font-weight: 900;
            cursor: pointer;
            background-color: #fff;
            user-select: none;
            outline: none;
            box-sizing: border-box;
        }

        /* --- ä¹å®®æ ¼é‚Šæ¡†åŠ æ·±é‚è¼¯ --- */
        /* æ¯ä¸‰åˆ—å³é‚ŠåŠ æ·± */
        .cell:nth-child(3n) { border-right: 4px solid #000; }
        .cell:nth-child(9n) { border-right: none; }
        /* æ¯ä¸‰è¡Œä¸‹é¢åŠ æ·± */
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 4px solid #000; }

        .cell.fixed { background-color: #f0f0f0; color: #555; cursor: default; }
        .cell.error { background-color: #ff4d4d !important; color: #fff !important; }

        /* ç‰¹æ•ˆå±¤ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #blood-overlay { background: radial-gradient(circle, rgba(255,0,0,0) 30%, rgba(180,0,0,0.8) 100%); z-index: 150; opacity: 0; transition: opacity 0.1s; }
        #taunt-overlay { background: rgba(0,0,0,0.95); z-index: 200; opacity: 0; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .taunt-text { font-size: 15vw; color: red; font-weight: 900; }

        .santa-sleigh { position: absolute; left: -200px; font-size: 80px; z-index: 100; }
        .gift-item { position: absolute; font-size: 40px; z-index: 101; animation: drop 3.5s linear forwards; }
        @keyframes drop {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        .controls { margin-top: 30px; }
        button {
            padding: 15px 40px; font-size: 24px; font-weight: bold; margin: 0 10px;
            cursor: pointer; border: none; border-radius: 12px; transition: 0.3s;
        }
        #solve-button { background: #e74c3c; color: white; }
        #new-game-button { background: #27ae60; color: white; }
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
    </style>
</head>
<body>

    <div class="container">
        <h1>æ•¸ ç¨</h1>
        <div id="sudoku-grid" class="grid"></div>
        <div class="controls">
            <button id="solve-button">è‡ªå‹•æ±‚è§£</button>
            <button id="new-game-button">æ–°éŠæˆ²</button>
        </div>
        <p id="message" style="font-size: 1.8rem; margin-top: 20px; font-weight: bold; color: #2c3e50;"></p>
    </div>

    <div id="blood-overlay" class="overlay"></div>
    <div id="taunt-overlay" class="overlay"><div class="taunt-text">ä½ è¶…å«©ï¼</div></div>
    <div id="celebration-overlay" class="overlay"></div>

    <script>
        const gridElement = document.getElementById('sudoku-grid');
        const bloodOverlay = document.getElementById('blood-overlay');
        const tauntOverlay = document.getElementById('taunt-overlay');
        const celebrationOverlay = document.getElementById('celebration-overlay');
        const container = document.querySelector('.container');
        const messageElement = document.getElementById('message');

        let initialGrid = [], currentGrid = [];
        const COLORS = ['#FFD700', '#FF69B4', '#00FFFF', '#ADFF2F', '#FF4500', '#FFFFFF', '#FFA500'];
        const ITEMS = ['ğŸ', 'â­', 'ğŸŒ™', 'ğŸ„', 'âœ¨', 'ğŸ­', 'â„ï¸'];

        // --- ä¿®æ­£å¾Œçš„æª¢æŸ¥é‚è¼¯ ---
        function isValid(board, r, c, n) {
            if (n === 0) return true;
            for (let i = 0; i < 9; i++) {
                // æª¢æŸ¥åˆ—è¡çª (æ’é™¤è‡ªå·±)
                if (i !== c && board[r][i] === n) return false;
                // æª¢æŸ¥è¡Œè¡çª (æ’é™¤è‡ªå·±)
                if (i !== r && board[i][c] === n) return false;
            }
            // æª¢æŸ¥ä¹å®®æ ¼è¡çª (æ’é™¤è‡ªå·±)
            let rs = Math.floor(r / 3) * 3, cs = Math.floor(c / 3) * 3;
            for (let i = rs; i < rs + 3; i++) {
                for (let j = cs; j < cs + 3; j++) {
                    if ((i !== r || j !== c) && board[i][j] === n) return false;
                }
            }
            return true;
        }

        function solveSudoku(board) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0) {
                        let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                        for (let n of nums) {
                            if (isValid(board, r, c, n)) {
                                board[r][c] = n;
                                if (solveSudoku(board)) return true;
                                board[r][c] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function initGame() {
            container.classList.remove('rotate-win');
            document.body.classList.remove('victory-bg');
            messageElement.textContent = "";
            let b = Array(9).fill(0).map(() => Array(9).fill(0));
            solveSudoku(b);
            
            // æŒ–æ‰ä¸€äº›æ•¸å­—
            for (let i = 0; i < 40; i++) {
                let r = Math.floor(Math.random() * 9), c = Math.floor(Math.random() * 9);
                b[r][c] = 0;
            }
            
            initialGrid = b.map(row => [...row]);
            currentGrid = b.map(row => [...row]);
            render();
        }

        function render() {
            gridElement.innerHTML = '';
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell' + (initialGrid[r][c] !== 0 ? ' fixed' : '');
                    cell.textContent = currentGrid[r][c] !== 0 ? currentGrid[r][c] : '';
                    if (initialGrid[r][c] === 0) {
                        cell.contentEditable = true;
                        cell.oninput = (e) => handleInput(e, r, c);
                    }
                    gridElement.appendChild(cell);
                }
            }
        }

        function handleInput(e, r, c) {
            const char = e.target.textContent.slice(-1);
            const val = parseInt(char);
            
            if (isNaN(val) || val === 0) {
                e.target.textContent = "";
                currentGrid[r][c] = 0;
                e.target.classList.remove('error');
                return;
            }
            
            e.target.textContent = val;
            currentGrid[r][c] = val; // å…ˆæ›´æ–°æ•¸å€¼

            // æª¢æŸ¥å‰›å¡«å…¥çš„é€™å€‹æ•¸å­—æ˜¯å¦ç¬¦åˆè¦å‰‡
            if (!isValid(currentGrid, r, c, val)) {
                e.target.classList.add('error');
                triggerBlood();
            } else {
                e.target.classList.remove('error');
            }
            checkWin();
        }

        function triggerBlood() {
            document.body.classList.add('shake-screen');
            bloodOverlay.style.opacity = '1';
            setTimeout(() => {
                document.body.classList.remove('shake-screen');
                bloodOverlay.style.opacity = '0';
            }, 300);
        }

        function checkWin() {
            // æª¢æŸ¥ç›¤é¢æ˜¯å¦å¡«æ»¿ä¸”ç„¡éŒ¯èª¤
            for(let r=0; r<9; r++) {
                for(let c=0; c<9; c++) {
                    if(currentGrid[r][c] === 0 || !isValid(currentGrid, r, c, currentGrid[r][c])) return;
                }
            }
            startCelebration();
        }

        function startCelebration() {
            document.body.classList.add('victory-bg');
            container.classList.add('rotate-win');
            messageElement.textContent = "ğŸ† å‹åˆ©ï¼èƒŒæ™¯è®Šç¶ ï¼Œè–èª•è€äººä¾†å•¦ï¼";
            celebrationOverlay.style.display = 'block';
            
            confetti({ particleCount: 250, spread: 100, origin: { y: 0.6 } });

            for (let i = 0; i < 10; i++) {
                const santa = document.createElement('div');
                santa.className = 'santa-sleigh';
                santa.textContent = 'ğŸ…ğŸ»';
                santa.style.top = (Math.random() * 70) + 'vh';
                const speed = 8 + Math.random() * 4;
                const delay = Math.random() * 4;
                santa.style.transition = `left ${speed}s linear ${delay}s`;
                celebrationOverlay.appendChild(santa);

                let giftTimer = setInterval(() => {
                    const rect = santa.getBoundingClientRect();
                    if (rect.left > window.innerWidth) return clearInterval(giftTimer);
                    
                    const gift = document.createElement('div');
                    gift.className = 'gift-item';
                    gift.textContent = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                    gift.style.left = (rect.left + 60) + 'px';
                    gift.style.top = rect.top + 'px';
                    gift.style.color = COLORS[Math.floor(Math.random() * COLORS.length)];
                    celebrationOverlay.appendChild(gift);
                }, 180);

                setTimeout(() => { santa.style.left = '120vw'; }, 100);
            }
        }

        document.getElementById('solve-button').onclick = () => {
            tauntOverlay.style.opacity = '1';
            setTimeout(() => {
                tauntOverlay.style.opacity = '0';
                currentGrid = initialGrid.map(row => [...row]);
                solveSudoku(currentGrid);
                render();
                messageElement.textContent = "å”‰ï¼Œä½ çœŸçš„è¶…å«©ã€‚";
            }, 1200);
        };

        document.getElementById('new-game-button').onclick = initGame;

        initGame();
    </script>
</body>
</html>
