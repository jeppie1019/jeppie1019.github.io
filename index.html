<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ç¨éŠæˆ²</title>
    <style>
        /* --- CSS æ¨£å¼ --- */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }

        .container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 450px; /* 9 * 50px */
            height: 450px; /* 9 * 50px */
            border: 3px solid #333;
            margin: 20px auto;
        }

        .cell {
            width: 50px;
            height: 50px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            box-sizing: border-box; 
            cursor: pointer;
            background-color: #fff;
            user-select: none; /* é˜²æ­¢å…§å®¹è¢«é¸ä¸­ */
        }

        .cell.fixed {
            background-color: #eee;
            color: #333;
            cursor: default;
        }

        .cell.editable {
            color: #007bff; /* ç”¨æˆ¶è¼¸å…¥çš„é¡è‰² */
            outline: none;
        }
        
        .cell:focus {
            background-color: #ffffcc; /* é»æ“Šæ™‚é«˜äº® */
        }
        
        .cell.error {
            background-color: #ffdddd; /* éŒ¯èª¤æç¤º */
            color: #cc0000 !important; 
        }

        /* ç²—ç·šåˆ†éš” 3x3 å®®æ ¼ */
        .cell:nth-child(3n) { border-right: 3px solid #333; }
        .cell:nth-child(9n + 1) { border-left: none; }
        .cell:nth-child(9n):not(:nth-child(81)) { border-right: none; }
        .cell:nth-child(27n) ~ .cell { border-top: 3px solid #333; }
        
        /* ä¿®æ­£é ‚éƒ¨å’Œå·¦å´é‚Šç•Œ */
        .cell:nth-child(1), .cell:nth-child(2), .cell:nth-child(3),
        .cell:nth-child(10), .cell:nth-child(11), .cell:nth-child(12),
        .cell:nth-child(19), .cell:nth-child(20), .cell:nth-child(21) { border-top: none; }
        .cell:nth-child(27n) { border-bottom: 3px solid #333; }
        .grid .cell:nth-last-child(-n+9) { border-bottom: none !important; }

        .controls button {
            padding: 10px 20px;
            margin: 10px 10px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #0056b3;
        }
        
        #message {
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ•¸ç¨éŠæˆ²</h1>
        
        <div id="sudoku-grid" class="grid">
            </div>

        <div class="controls">
            <button id="solve-button">è‡ªå‹•æ±‚è§£</button>
            <button id="new-game-button">æ–°éŠæˆ²</button>
        </div>
        
        <p id="message"></p>
    </div>

    <script>
        /* --- JavaScript æ ¸å¿ƒé‚è¼¯ --- */
        const GRID_SIZE = 9;
        const gridElement = document.getElementById('sudoku-grid');
        const solveButton = document.getElementById('solve-button');
        const newGameButton = document.getElementById('new-game-button');
        const messageElement = document.getElementById('message');

        let currentGrid = []; // ç”¨æˆ¶ç•¶å‰è¼¸å…¥çš„ç‹€æ…‹
        let initialGrid = []; // åˆå§‹è¬é¡Œç‹€æ…‹

        // --- æ ¸å¿ƒæ¼”ç®—æ³•ï¼šå›æº¯æ³•æª¢æŸ¥èˆ‡æ±‚è§£ ---

        /**
         * æª¢æŸ¥åœ¨çµ¦å®šä½ç½® (row, col) æ”¾ç½® number æ˜¯å¦æœ‰æ•ˆã€‚
         */
        function isValid(board, row, col, number) {
            // æª¢æŸ¥è¡Œå’Œåˆ—
            for (let k = 0; k < GRID_SIZE; k++) {
                if (board[row][k] === number || board[k][col] === number) {
                    return false;
                }
            }

            // æª¢æŸ¥ 3x3 å®®æ ¼
            const boxRowStart = row - (row % 3);
            const boxColStart = col - (col % 3);
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[boxRowStart + i][boxColStart + j] === number) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        /**
         * æª¢æŸ¥ç•¶å‰ç”¨æˆ¶è¼¸å…¥çš„æ•¸å­—æ˜¯å¦èˆ‡æ•¸ç¨è¦å‰‡è¡çª
         */
        function isUserMoveValid(board, row, col, number) {
             // æš«æ™‚å°‡ç•¶å‰ä½ç½®è¨­ç‚º 0ï¼Œé¿å…æª¢æŸ¥åˆ°è‡ªèº«
            let temp = board[row][col];
            board[row][col] = 0; 
            const valid = isValid(board, row, col, number);
            board[row][col] = temp; // æ¢å¾©æ•¸å­—
            return valid;
        }


        /**
         * ä½¿ç”¨å›æº¯æ³•æ±‚è§£æ•¸ç¨ã€‚
         */
        function solveSudoku(board) {
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    if (board[i][j] === 0) {
                        for (let number = 1; number <= 9; number++) {
                            if (isValid(board, i, j, number)) {
                                board[i][j] = number;
                                if (solveSudoku(board)) {
                                    return true;
                                }
                                board[i][j] = 0; // å›æº¯
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }
        
        // --- éŠæˆ²ç”Ÿæˆèˆ‡æ¸²æŸ“ ---

        /**
         * éš¨æ©Ÿç”Ÿæˆä¸€å€‹æ•¸ç¨è¬é¡Œï¼ˆç°¡åŒ–ç‚ºå¾ä¸€å€‹å·²çŸ¥è§£æŒ–æ´ï¼‰
         */
        function generateSudoku() {
            // ç¢ºä¿æœ‰ä¸€å€‹æœ‰æ•ˆçš„èµ·å§‹è§£æ±ºæ–¹æ¡ˆ
            const solved = [
                [5, 3, 4, 6, 7, 8, 9, 1, 2],
                [6, 7, 2, 1, 9, 5, 3, 4, 8],
                [1, 9, 8, 3, 4, 2, 5, 6, 7],
                [8, 5, 9, 7, 6, 1, 4, 2, 3],
                [4, 2, 6, 8, 5, 3, 7, 9, 1],
                [7, 1, 3, 9, 2, 4, 8, 5, 6],
                [9, 6, 1, 5, 3, 7, 2, 8, 4],
                [2, 8, 7, 4, 1, 9, 6, 3, 5],
                [3, 4, 5, 2, 8, 6, 1, 7, 9]
            ];
            
            let puzzle = solved.map(row => [...row]); 

            // æŒ–æ´æ•¸é‡ (é›£åº¦ï¼Œç´„ 40 å€‹ç©ºä½ç‚ºä¸­ç­‰)
            let holes = 40; 
            let count = 0;
            while (count < holes) {
                let r = Math.floor(Math.random() * 9);
                let c = Math.floor(Math.random() * 9);
                if (puzzle[r][c] !== 0) {
                    puzzle[r][c] = 0;
                    count++;
                }
            }
            return puzzle;
        }


        /**
         * æ¸²æŸ“æ•¸ç¨éŠæˆ²æ¿åˆ° HTML 
         */
        function renderGrid(board, highlightErrors = false) {
            gridElement.innerHTML = ''; 

            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    const value = board[i][j];
                    
                    if (initialGrid[i][j] !== 0) {
                        cell.textContent = value;
                        cell.classList.add('fixed');
                    } else {
                        // å¯ç·¨è¼¯å–®å…ƒæ ¼
                        if (value !== 0) {
                            cell.textContent = value;
                            cell.classList.add('editable');
                            
                            // æª¢æŸ¥ç•¶å‰æ•¸å­—æ˜¯å¦å°è‡´è¡çª
                            if (highlightErrors && !isUserMoveValid(board, i, j, value)) {
                                cell.classList.add('error');
                            }
                        }
                        
                        cell.contentEditable = 'true'; 
                        cell.setAttribute('inputmode', 'numeric'); // é‡å°ç§»å‹•è¨­å‚™
                        cell.addEventListener('input', handleCellInput);
                        cell.addEventListener('keydown', restrictInput);
                    }
                    gridElement.appendChild(cell);
                }
            }
        }

        // --- ç”¨æˆ¶è¼¸å…¥è™•ç† ---

        /**
         * é™åˆ¶ç”¨æˆ¶è¼¸å…¥ï¼Œåªå…è¨± 1-9 å–®å€‹æ•¸å­—æˆ–æ¸…é™¤ã€‚
         */
        function restrictInput(event) {
            const key = event.key;
            // å…è¨± Backspace, Delete, Arrow Keys
            if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) {
                return; 
            }
            // åªå…è¨± 1-9 çš„æ•¸å­—éµ
            if (!/^[1-9]$/.test(key)) {
                event.preventDefault();
            }
            // ç¢ºä¿å–®å…ƒæ ¼å…§åªä¿ç•™ä¸€å€‹å­—ç¬¦
            if (event.target.textContent.length >= 1 && !['Backspace', 'Delete'].includes(key)) {
                event.preventDefault();
            }
        }


        /**
         * è™•ç†ç”¨æˆ¶è¼¸å…¥ä¸¦æ›´æ–°éŠæˆ²ç‹€æ…‹
         */
        function handleCellInput(event) {
            const cell = event.target;
            let value = cell.textContent.trim();
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            // 1. æ¸…ç†å’Œé©—è­‰è¼¸å…¥
            if (!/^[1-9]$/.test(value)) {
                cell.textContent = ''; 
                currentGrid[row][col] = 0;
            } else {
                cell.textContent = value; 
                currentGrid[row][col] = parseInt(value);
            }
            
            // 2. é‡æ–°æ¸²æŸ“ä»¥æª¢æŸ¥éŒ¯èª¤
            renderGrid(currentGrid, true); 
            
            // 3. æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
            if (checkIfSolved()) {
                updateMessage('ğŸ‰ æ­å–œï¼æ•¸ç¨å·²è§£é–‹ï¼', 'green');
            } else {
                // å¦‚æœæœ‰éŒ¯èª¤ï¼Œä¿æŒéŒ¯èª¤æç¤ºï¼›å¦å‰‡æ¸…ç©ºè¨Šæ¯
                if (!cell.classList.contains('error')) {
                     updateMessage('');
                }
            }
        }

        /**
         * æª¢æŸ¥ç•¶å‰éŠæˆ²æ¿æ˜¯å¦å®Œå…¨è§£é–‹ä¸”æ­£ç¢º
         */
        function checkIfSolved() {
